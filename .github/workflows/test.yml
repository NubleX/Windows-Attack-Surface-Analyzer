name: Test Security Analyzer

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  lint:
    name: PSScriptAnalyzer
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install PSScriptAnalyzer
        shell: pwsh
        run: Install-Module PSScriptAnalyzer -Force -Scope CurrentUser

      - name: Lint - Errors only (fail build)
        shell: pwsh
        run: |
          $results = Invoke-ScriptAnalyzer `
            -Path .\WindowsAttackSurfaceAnalyzer.ps1 `
            -Severity Error
          if ($results) {
            $results | Format-Table -AutoSize
            Write-Error "PSScriptAnalyzer found $($results.Count) error(s). Build failed."
            exit 1
          }
          Write-Host "No errors found."

      - name: Lint - Warnings (informational, does not fail build)
        shell: pwsh
        run: |
          $results = Invoke-ScriptAnalyzer `
            -Path .\WindowsAttackSurfaceAnalyzer.ps1 `
            -Severity Warning `
            -ExcludeRule PSAvoidUsingWriteHost,PSUseShouldProcessForStateChangingFunctions
          if ($results) {
            Write-Warning "$($results.Count) warning(s) found (informational only):"
            $results | Format-Table RuleName, Severity, Line, Message -AutoSize
          } else {
            Write-Host "No warnings found."
          }

  test:
    name: Run Analyzer
    runs-on: windows-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - name: Show system info
        shell: pwsh
        run: |
          Write-Host "OS: $([System.Environment]::OSVersion.VersionString)"
          Write-Host "PowerShell: $($PSVersionTable.PSVersion)"
          Write-Host "Build: $((Get-CimInstance Win32_OperatingSystem).BuildNumber)"

      - name: Run analyzer (non-admin, export report)
        shell: pwsh
        run: |
          .\WindowsAttackSurfaceAnalyzer.ps1 -Export -OutputPath .\report.html
        continue-on-error: false

      - name: Verify report was created
        shell: pwsh
        run: |
          if (-not (Test-Path .\report.html)) {
            Write-Error "HTML report was not generated."
            exit 1
          }
          $size = (Get-Item .\report.html).Length
          Write-Host "Report generated: report.html ($size bytes)"

      - name: Upload HTML report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-report
          path: report.html
          retention-days: 30
