name: Publish to PowerShell Gallery

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run - validate only, do not publish'
        required: true
        default: true
        type: boolean

jobs:
  publish:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Assemble module folder
        shell: pwsh
        run: |
          # PowerShell Gallery requires a folder named exactly after the module
          $module = 'WindowsAttackSurfaceAnalyzer'
          $dest   = Join-Path $env:RUNNER_TEMP $module
          New-Item -ItemType Directory -Path $dest -Force | Out-Null

          foreach ($file in @("$module.ps1", "$module.psm1", "$module.psd1")) {
            if (-not (Test-Path $file)) {
              Write-Error "Required file not found in repo root: $file"
              exit 1
            }
            Copy-Item $file $dest
            Write-Host "Copied: $file"
          }

          foreach ($optional in @('LICENSE', 'README.md')) {
            if (Test-Path $optional) {
              Copy-Item $optional $dest
              Write-Host "Copied: $optional"
            }
          }

          Write-Host "`nModule folder contents:"
          Get-ChildItem $dest | Format-Table Name, Length -AutoSize

          "MODULE_PATH=$dest" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Validate manifest
        shell: pwsh
        run: |
          $manifest = Join-Path $env:MODULE_PATH 'WindowsAttackSurfaceAnalyzer.psd1'
          $result   = Test-ModuleManifest -Path $manifest -ErrorAction Stop
          Write-Host "Name    : $($result.Name)"
          Write-Host "Version : $($result.Version)"
          Write-Host "Author  : $($result.Author)"
          Write-Host "GUID    : $($result.Guid)"

      - name: Check version matches release tag
        if: github.event_name == 'release'
        shell: pwsh
        run: |
          $tag      = '${{ github.event.release.tag_name }}' -replace '^v', ''
          $tagBase  = ($tag -split '-')[0]
          $manifest = Join-Path $env:MODULE_PATH 'WindowsAttackSurfaceAnalyzer.psd1'
          $data     = Import-PowerShellDataFile $manifest
          $version  = $data.ModuleVersion

          Write-Host "Release tag : $tag  (base: $tagBase)"
          Write-Host "Manifest    : $version"

          if ($tagBase -ne $version) {
            Write-Error "Version mismatch: tag '$tagBase' != manifest '$version'. Update ModuleVersion in the .psd1 before releasing."
            exit 1
          }
          Write-Host "Version check passed."

      - name: Run PSScriptAnalyzer
        shell: pwsh
        run: |
          Install-Module PSScriptAnalyzer -Force -SkipPublisherCheck -ErrorAction Stop
          $issues = Invoke-ScriptAnalyzer -Path $env:MODULE_PATH -Severity Error -Recurse
          if ($issues) {
            $issues | Format-Table RuleName, Message, Line -AutoSize
            Write-Error "PSScriptAnalyzer found $($issues.Count) error(s). Fix before publishing."
            exit 1
          }
          Write-Host "PSScriptAnalyzer: no errors."

      - name: Dry run
        if: github.event_name == 'workflow_dispatch' && inputs.dry_run == true
        shell: pwsh
        run: |
          $data = Import-PowerShellDataFile (Join-Path $env:MODULE_PATH 'WindowsAttackSurfaceAnalyzer.psd1')
          Write-Host "DRY RUN - all validation passed."
          Write-Host "Would publish: $($data.RootModule) v$($data.ModuleVersion)"
          Write-Host "Module path  : $env:MODULE_PATH"

      - name: Publish to PowerShell Gallery
        if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && inputs.dry_run == false)
        shell: pwsh
        env:
          PSGALLERY_API_KEY: ${{ secrets.PSGALLERY_API_KEY }}
        run: |
          if (-not $env:PSGALLERY_API_KEY) {
            Write-Error "Secret PSGALLERY_API_KEY is not set. Go to Settings > Secrets > Actions and add it."
            exit 1
          }

          Publish-Module `
            -Path $env:MODULE_PATH `
            -NuGetApiKey $env:PSGALLERY_API_KEY `
            -Verbose `
            -ErrorAction Stop

          $data = Import-PowerShellDataFile (Join-Path $env:MODULE_PATH 'WindowsAttackSurfaceAnalyzer.psd1')
          Write-Host ""
          Write-Host "Published successfully: v$($data.ModuleVersion)"
          Write-Host "https://www.powershellgallery.com/packages/WindowsAttackSurfaceAnalyzer"
